<%- include header %><!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        <%= title %>
      </h1>
    </section>
    <!-- Main content -->
    <section class="content container-fluid">
      <div class="row">
        <div class="col-md-12 flex-fill">
          <div class="box box-danger" style="width: fit-content; min-width: 100%">
            <div class="box-body">
              <p>Parent Code</p>
              <table class="table table-bordered">
                <tr class="hidden-row">
                  <td>Enter Parent Code</td>
                  <td>Parent Name</td>
                  <td>Parent Role</td>

                </tr>
                
                <tr class="hidden-row">
                  <td style="width: 295px;">
                    <select id="searchId" class="form-control search-user" name="state" oninput="getParentName()"></select>
                  </td>
                  <td>
                    <input name="parentName" id="parentName" class="form-control" readonly></input>
                  </td>
                  <td>
                    <input name="parentRole" id="parentRole" class="form-control" readonly></input>
                  </td>
                </tr>
                <tr class="hidden-row">

                  <td>Parent Area</td>
                </tr>
                
                <tr class="hidden-row">
                  <td>
                    <input name="parentarea" id="parentarea" class="form-control" readonly></input>
                  </td>
                </tr>
                
                <!-- </tr> -->
              </table>
            </div>
          </div>
        </div>
         <div class="col-md-12 flex-fill">
          <div class="box box-danger" style="width: fit-content; min-width: 100%">
            <div class="box-body">
              <p>New Assign Role</p>
              <table class="table table-bordered">
                <tr class="hidden-row">
                  <td>Frist Name</td>
                  <td>Last Name</td>
                  <td>Phone Number</td>
                </tr>
                
                  <tr class="hidden-row">
                    <td style="width: 274px;">
                      <input name="firstName" id="firstName" class="form-control" placeholder="Enter Frist Name here...."></input>
                    </td>
                    <td style="    width: 311px;">
                      <input name="lastName" id="lastName" class="form-control" placeholder="Enter Last Name here...."></input>
                    </td>
                    <td>
                      <input name="phone" id="phone" class="form-control" placeholder="Enter Phone Number here...."></input>
                    </td>
                  </tr>

                <tr class="hidden-row">
                  <td>Email Id</td>
                  <td>Select State</td>
                  <td>Select District</td>
                </tr>
      
                  <tr class="hidden-row">

                    <td>
                      <input name="email" id="email" class="form-control" placeholder="Enter Email Id here...."></input>
                    </td>
                    <td>
                      <select name="userState" id="userState" class="form-control" onchange="getDistrictData()">
                        <% data.allState.forEach(state => { %>
                          <option value="<%= state %>"><%= state %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                    <select name="district" id="district" class="form-control">
                      <option value="">Select District</option>
                    
                    </select>
                  </td>
                  </tr>
                <tr class="hidden-row">
                  <td>Full Address</td>
                  <td>Pin Code</td>
                  <td>Paasword</td>
                </tr>
                
                  <tr class="hidden-row">
                    <td>
                      <input name="address" id="address" class="form-control" placeholder="Enter Full Address here...."></input>
                    </td>
                    <td>
                      <input name="pinCode" id="pinCode" class="form-control" placeholder="Enter Pin Code here...."></input>
                    </td>
                    <td>
                      <input name="password" id="password" class="form-control" placeholder="Enter Paasword here...."></input>
                    </td>
                    
                  </tr>              
                <tr>
                <tr class="hidden-row">
                  <td>Confirm Paasword</td>
                  <td>User Role</td>
                  <td>User Security Pin</td>
                </tr>
                  <tr class="hidden-row">
                    <td>
                      <input name="cPassword" id="cPassword" class="form-control" placeholder="Enter Confirm Paasword here...."></input>
                    </td>
                    <td>
                      <input name="parentName" id="parentName" class="form-control" value="User" readonly></input>
                    </td>
                    <td>
                      <input name="userSecurityPin" type="number"  id="userSecurityPin" class="form-control" placeholder="Enter User Security Pin "></input>
                    </td>
                  </tr>
                <tr>
                  <tr class="hidden-row">
                    <td>Security Pin</td>
                  </tr>
                    <tr class="hidden-row">
                      <td>
                        <input name="securityPin" type="number"  id="securityPin" class="form-control" placeholder="Enter Security Pin "></input>
                      </td>
                  <tr>
                  <td>
                    <button type="button" class="btn btn-success" onclick="saveSettings()">
                      Save
                    </button>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      
      </div>
    </section>
  </div>
  <%- include footer %>
    <script>
      let stateAl;
      let a=[];
      let districtData;
    const saveSettings = () => {
        const parentId = a[0];
        let  districtAllocation=""
        let  stateAllocation = "";
        let  areaAllocation = "";
        const userSecurityPin = document.getElementById("userSecurityPin").value;
        const firstName = document.getElementById("firstName").value;
        const lastName = document.getElementById("lastName").value;
        const phone = document.getElementById("phone").value;
        const email = document.getElementById("email").value;
        const userState = document.getElementById("userState").value;
        const userDistrict = document.getElementById("district").value;
        const address = document.getElementById("address").value;
        const pinCode = document.getElementById("pinCode").value;
        const aadharNumber = ""
        const password = document.getElementById("password").value;
        const cPassword = document.getElementById("cPassword").value;
        const securityPin = document.getElementById("securityPin").value;
        const userRole = "User"
        
        // console.log({parentId,districtAllocation, areaAllocation,firstName, lastName, phone, email, userState, userDistrict, address, pinCode, aadharNumber, password, cPassword, securityPin, userRole})
        fetch("/admin/saveAddRank", {
          method: "POST",
          body: JSON.stringify({parentId, stateAllocation,districtAllocation, areaAllocation,firstName, lastName, phone, email, userState, userDistrict, address, pinCode, aadharNumber, password, cPassword, securityPin, userRole,userSecurityPin}),
          headers: {
            "Content-Type": "application/json",
          },
        })
        .then(response => response.json())
          .then(response => {
            const title = response.status == 1 ? "Success" : "Error";
            swal({
              icon: response.status == 1 ? "success" : "error",
              title: response.Msg
            }).then(() => {
              if(response.status==1){
                  // console.log("hi");
                window.location.reload();
              }
            });
          })
          .catch((error) => {
            console.log(error);
            swal({ icon: "error", title: "An error occurred" }).then(() => {
              window.location.reload();
            });
          });
      };
    </script>
  <script>
    const getParentName = (selectedParentId) => {
      fetch("/admin/getParentName?search_id=" + selectedParentId, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      })
      .then(response => response.json())
      .then(response => {
        // console.log(response);
        const parentName = document.getElementById("parentName");
        parentName.value = response.parentName.name;
        
        stateAl=response.parentName.stateAllocated
        const parentRole = document.getElementById("parentRole");
        parentRole.value = response.parentName.role;
        
        const parentArea = document.getElementById("parentarea");
        parentArea.value = response.parentName.areaAllocation
        
        const userRole=document.getElementById("userRole");
        userRole.value=response.rolesBelow[0]
      })
      .catch(error => {
        console.error("Error fetching parent name:", error);
      });
    };

    var table = $('#example').DataTable();
  
    $('.search-user').select2({
            allowClear: true,
            placeholder: 'Search user',
            ajax: {
                url: '/admin/find_userByRole',
                data: function (params) {
                    var query = {
                        search: params.term,
                        type: 'public',
                        role: "Agent"
                    }
                    // Query parameters will be ?search=[term]&type=public
                    return query;
                }
            }
        });
  
    $('.search-user').on('select2:select', function (e) {
      THAT_ID = e.params.data.id;
      table.ajax.reload();
      getParentName(THAT_ID);
      // console.log(THAT_ID);
       a.push(THAT_ID);
    });
  
    $(".search-user").on("select2:clearing", function (e) {
      // console.log('cleared');
      THAT_ID = "";
      table.ajax.reload();
    });

const getDistrictData = () => {

  const selectedState = document.getElementById("userState").value;
  console.log("Goa")
  // console.log("Selected State:", selectedState,district);

  fetch("/admin/getIndianDistrict?state=" + selectedState , {
    method: "GET",
    headers: {
      "Content-Type": "applicati on/json",
    },
  })
    .then(response => response.json())
    .then(response => {
      // console.log(response);

      const districts = response.district;

      const districtDropdown = document.getElementById("district");

      districtDropdown.innerHTML = "";

      const defaultOption = document.createElement("option");
      defaultOption.text = "Select District";
      districtDropdown.add(defaultOption);

      districts.forEach(district => {
        console.log("heiiiiii")
        const option = document.createElement("option");
        option.value = district;
        option.text = district;
        districtDropdown.add(option);
      });
    })
    .catch(error => {
      console.error("Error fetching districts:", error);
    });
};
  </script>