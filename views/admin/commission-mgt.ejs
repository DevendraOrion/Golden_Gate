<%- include header %>
<style>
  .card {
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    padding: 10px;
  }
td{
  border-radius: 4px;
}
  .card-body {
    background-color: #f8f9fa;
    padding: 10px;
  }
</style>
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <h1>
      <%= title %>
    </h1>
  </section>
  <!-- Main content -->
  <section class="content container-fluid">
    <div class="row">
      <% const generateGameTable = (gameType, gameData) => { %>
        <div class="col-md-12 d-flex">
          <div class="col-md-12 flex-fill">
            <h3><%= gameType %></h3>
            <div class="box box-danger">
              <div class="box-body">
                <table class="table table-bordered">
                  <tr>
                    <th>Rank Id</th>
                    <th>Rank Name</th>
                    <th>Available Commission</th>
                    <th>Assignable Commission</th>
                    <th>Own Commission</th>
                    <th>Minimum Commission</th>
                  </tr>
                  <% let i=0 %>
                  <% for (const d of gameData) { 
                    if(i==0){
                      i++;
                      continue;
                    } %>
                    <tr data-rank-id="<%= d.rankId %>" data-game-type="<%= gameType %>">
                      <input type="hidden" id="gameType<%= gameType %>" class="form-control" value="<%= gameType %>" readonly>
                      <td>
                        <input type="number" id="rankId<%= gameType %><%= d.rankId %>" class="form-control" value="<%= d.rankId %>" readonly>
                      </td>
                      <td>
                        <input id="rankName<%= gameType %><%= d.rankId %>" class="form-control" value="<%= d.rankName %>" readonly>
                      </td>
                      <td>
                        <input id="availableCommission<%= gameType %><%= d.rankId %>" class="form-control" value="<%= gameData[i-1]?.commissionData.availableCommission ?? 0 %>" readonly>
                      </td>
                      <td>
                        <input id="downline<%= gameType %><%= d.rankId %>" class="form-control" type="number" value="<%= d?.commissionData.availableCommission ?? 0 %>" oninput="updateOwnCommission('<%= gameType %>', <%= d.rankId %>)">
                      </td>
                      <td>
                        <input id="ownCommission<%= gameType %><%= d.rankId %>" class="form-control" value="<%= (gameData[i-1]?.commissionData.availableCommission ?? 0)-(d?.commissionData.availableCommission ?? 0) %>" readonly>
                      </td>
                      <td>
                        <input id="minCommission<%= gameType %><%= d.rankId %>" class="form-control" value="<%= d?.commissionData.minCommission ?? 0 %>" >
                      </td>
                    </tr>
                  <% i++ } %>
                  <tr>
                    <td>
                      <button type="button" id="type<%= gameType %>" data-type="<%= gameType %>" class="btn btn-success" onclick="saveCommission('<%= gameType %>')">
                        Save
                      </button>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      <% } %>

      <% generateGameTable('Roulette', data.RoulleteData); %>
      <% generateGameTable('Aviator', data.AvaitorData); %>
      <% generateGameTable('CardRoulette', data.CardRoulleteData); %>
    </div>
  </section>

  <!-- /.content -->
</div>
<!-- /.content-wrapper -->
<%- include footer %>
<script>
const updateOwnCommission = (gameType, rankId) => {
  const availableValue = parseFloat(document.getElementById(`availableCommission${gameType}${rankId}`).value) || 0;
  const downlineValue = parseFloat(document.getElementById(`downline${gameType}${rankId}`).value) || 0;
  const ownCommissionElement = document.getElementById(`ownCommission${gameType}${rankId}`);
  const minCommissionElement = document.getElementById(`minCommission${gameType}${rankId}`);
  const assignableCommissionElement = document.getElementById(`downline${gameType}${rankId}`);

  const ownCommissionValue = availableValue - downlineValue;
console.log(availableValue,downlineValue,ownCommissionValue,minCommissionElement.value,assignableCommissionElement.value);
  if (assignableCommissionElement.value > availableValue) {
    assignableCommissionElement.value = availableValue;
  }

  if (assignableCommissionElement.value < minCommissionElement.value) {
    assignableCommissionElement.value = minCommissionElement.value;
  }

  ownCommissionElement.value = ownCommissionValue;
};

const saveCommission = (gameType) => {
  const dataRows = document.querySelectorAll(`tr[data-rank-id][data-game-type="${gameType}"]`);
  const rowData = [];

  dataRows.forEach((row) => {
    const rankId = row.getAttribute("data-rank-id");
    const rankName = document.getElementById(`rankName${gameType}${rankId}`).value;
    const availableCommission = document.getElementById(`downline${gameType}${rankId}`).value;
    const minCommission = document.getElementById(`minCommission${gameType}${rankId}`).value;

    rowData.push({ rankId, rankName, availableCommission, minCommission });
  });

  fetch("/admin/saveCommission-mgt", {
    method: "POST",
    body: JSON.stringify({ gameType, rowData }),
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then((response) => response.json())
    .then((response) => {
      const title = response.status == 1 ? "Success" : "Error";
      swal({
        icon: response.status == 1 ? "success" : "error",
        title: response.Msg,
      }).then(() => {
        if (response.status == 1) {
          window.location.reload();
        }
      });
    })
    .catch((error) => {
      console.log(error);
      swal({ icon: "error", title: "An error occurred" }).then(() => {
        window.location.reload();
      });
    });
};


</script>
